<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Parmina Network</title>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    #sidebar {
      transform: translateX(-100%);
    }
    #sidebar.show {
      transform: translateX(0);
    }
    @media (min-width: 768px) {
      #sidebar {
        transform: none;
      }
    }
    .transition-soft {
      transition: transform 0.4s ease-in-out;
    }
    .animate-slide {
      transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row">
  <!-- Toggle Button for Mobile -->
  <div class="p-4 md:hidden flex justify-between items-center bg-white shadow">
    <button onclick="toggleSidebar()" class="text-green-700 focus:outline-none">
      <svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path id="menuPath" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
    <h2 class="text-xl font-bold text-green-700">Parmina Network</h2>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="bg-white w-64 p-4 shadow-lg transition-soft md:translate-x-0 md:relative fixed z-50 top-0 left-0 h-screen">
    <h2 class="text-2xl font-bold text-green-700 mb-6 hidden md:block">Parmina Network</h2>
    <nav>
      <ul class="space-y-2">
        <li><button type="button" onclick="navigateMenu('home')" class="text-green-700 hover:underline">üè† Beranda</button></li>
        <li><button type="button" onclick="navigateMenu('network')" class="text-green-700 hover:underline">üåø Jaringan Saya</button></li>
        <li><button type="button" onclick="navigateMenu('komisi')" class="text-green-700 hover:underline">üí∏ Komisi Saya</button></li>
        <li><button type="button" onclick="navigateMenu('bonus')" class="text-green-700 hover:underline">üéÅ Bonus Reward</button></li>
        <li><button type="button" onclick="navigateMenu('riwayat')" class="text-green-700 hover:underline">üìÑ Riwayat Transaksi</button></li>
        <li><button type="button" onclick="navigateMenu('bop')" class="text-green-700 hover:underline">üì¢ BOP</button></li>
        <li><button type="button" onclick="navigateMenu('webinar')" class="text-green-700 hover:underline">üßë‚Äçüíª Webinar</button></li>
        <li><button type="button" onclick="navigateMenu('seminar')" class="text-green-700 hover:underline">üéì Boost Seminar</button></li>
        <li><button type="button" onclick="navigateMenu('galeri')" class="text-green-700 hover:underline">üñºÔ∏è Galeri</button></li>
        <li><button type="button" onclick="navigateMenu('profil')" class="text-green-700 hover:underline">üë§ Profil & Akun</button></li>
        <li><button onclick="logoutUser()" class="text-red-600 hover:underline">üö™ Logout</button></li>
      </ul>
    </nav>
  </aside>

  <!-- Content -->
  <main class="flex-1 p-6 md:ml-0" id="mainContent">
    <section id="homeSection">
      <h1 class="text-2xl font-bold text-green-700 mb-4">Selamat Datang, <span id="userName">User</span> <span id="userBadge"></span></h1>
      <p><strong>Status:</strong> <span id="userStatus" class="font-semibold">Memuat...</span></p>
      <p><strong>Pembelian Pribadi:</strong> Rp<span id="personalPurchase">0</span></p>
      <p><strong>Omzet Jaringan:</strong> Rp<span id="networkOmzet">0</span></p>
      <p><strong>Sponsor:</strong> <span id="userSponsor">Memuat...</span></p>
      <p><strong>Upline:</strong> <span id="userParent">Memuat...</span></p>
    </section>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC6CD-KssIaBO0lGZbf5ymrH03uVfbNP-k",
      authDomain: "parminanetwork.firebaseapp.com",
      projectId: "parminanetwork",
      storageBucket: "parminanetwork.firebasestorage.app",
      messagingSenderId: "736943184054",
      appId: "1:736943184054:web:31fed7a4d10442870e2e17"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        try {
          // Cari dokumen berdasarkan UID atau username jika UID random
          const userQuery = await db.collection('users').where('email', '==', user.email).get();
          if (!userQuery.empty) {
            const userDoc = userQuery.docs[0];
            const data = userDoc.data();

            document.getElementById("userName").textContent = data.nama || "User";
            document.getElementById("personalPurchase").textContent = data.pembelianPribadi || 0;
            document.getElementById("networkOmzet").textContent = data.omzetJaringan || 0;

            const statusEl = document.getElementById("userStatus");
            const aktif = data.statusAktif === true || data.statusAktif === "true" || data.isTopLevel === true;
            statusEl.textContent = aktif ? "Aktif Bulan Ini" : "Belum Aktif Bulan Ini";
            statusEl.classList.remove("text-green-600", "text-red-600");
            statusEl.classList.add(aktif ? "text-green-600" : "text-red-600");

            if (data.isTopLevel === true) {
              document.getElementById("userBadge").innerHTML = "<span title='Top Leader' class='ml-2'>üëë</span>";
            }

            // Tampilkan nama + email untuk sponsor dan parent
            if (data.sponsorID) {
              const sponsorRef = await db.collection('users').doc(data.sponsorID).get();
              const sponsorData = sponsorRef.data();
              document.getElementById("userSponsor").textContent =
              sponsorData ? `${sponsorData.name} (${sponsorData.email})` : data.sponsorID;
            }

            if (data.parentID) {
              const parentRef = await db.collection('users').doc(data.parentID).get();
              const parentData = parentRef.data();
              document.getElementById("userParent").textContent =
              parentData ? `${parentData.name} (${parentData.email})` : data.parentID;
            }
          } else {
            console.log("Dokumen pengguna tidak ditemukan.");
          }
        } catch (e) {
          console.error("Gagal load data pengguna:", e);
        }
      } else {
        window.location.href = "index.html";
      }
    });

    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const path = document.getElementById("menuPath");
      sidebar.classList.toggle("show");
      const isOpen = sidebar.classList.contains("show");
      path.setAttribute("d", isOpen ? "M6 18L18 6M6 6l12 12" : "M4 6h16M4 12h16M4 18h16");
    }

    function navigateMenu(menu) {
      const mainContent = document.getElementById("mainContent");

      if (menu === "home") {
        // Balikin tampilan beranda awal
        mainContent.innerHTML = `
          <section id="homeSection">
            <h1 class="text-2xl font-bold text-green-700 mb-4">Selamat Datang, <span id="userName">User</span> <span id="userBadge"></span></h1>
            <p><strong>Status:</strong> <span id="userStatus" class="font-semibold">Memuat...</span></p>
            <p><strong>Pembelian Pribadi:</strong> Rp<span id="personalPurchase">0</span></p>
            <p><strong>Omzet Jaringan:</strong> Rp<span id="networkOmzet">0</span></p>
            <p><strong>Sponsor:</strong> <span id="userSponsor">Memuat...</span></p>
            <p><strong>Parent Matrix:</strong> <span id="userParent">Memuat...</span></p>
          </section>`;
    
        // Trigger ulang ambil data user buat ngisi ulang
        firebase.auth().onAuthStateChanged(async (user) => {
          if (user) {
            try {
              const userQuery = await db.collection('users').where('email', '==', user.email).get();
              if (!userQuery.empty) {
                const userDoc = userQuery.docs[0];
                const data = userDoc.data();

                document.getElementById("userName").textContent = data.name || "User";
                document.getElementById("personalPurchase").textContent = data.pembelianPribadi || 0;
                document.getElementById("networkOmzet").textContent = data.omzetJaringan || 0;

                const statusEl = document.getElementById("userStatus");
                const aktif = data.statusAktif === true || data.statusAktif === "true" || data.isTopLevel === true;
                statusEl.textContent = aktif ? "Aktif Bulan Ini" : "Belum Aktif Bulan Ini";
                statusEl.classList.remove("text-green-600", "text-red-600");
                statusEl.classList.add(aktif ? "text-green-600" : "text-red-600");

                if (data.isTopLevel === true) {
                  document.getElementById("userBadge").innerHTML = "<span title='Top Leader' class='ml-2'>üëë</span>";
                }

                // Ambil sponsor dan parent (versi lengkap)
                if (data.sponsorID) {
                  const sponsorSnap = await db.collection("users").doc(data.sponsorID).get();
                  const sponsor = sponsorSnap.data();
                  document.getElementById("userSponsor").textContent = sponsor ? `${sponsor.name} (${sponsor.email})` : "-";
                } else {
                  document.getElementById("userSponsor").textContent = "-";
                }

                if (data.parentID) {
                  const parentSnap = await db.collection("users").doc(data.parentID).get();
                  const parent = parentSnap.data();
                  document.getElementById("userParent").textContent = parent ? `${parent.name} (${parent.email})` : "-";
                } else {
                  document.getElementById("userParent").textContent = "-";
                }
              }
            } catch (e) {
              console.error("Gagal load ulang beranda:", e);
            }
          }
        });
        
      } else {
        // Untuk menu selain home, isi dummy
        mainContent.innerHTML = `
          <div class="flex items-center justify-center mt-10 animate-pulse">
            <p class="text-green-700 text-lg font-semibold">Memuat konten <span class="capitalize">${menu}</span>...</p>
          </div>`;
        setTimeout(() => {
          if (menu === "network") {
            mainContent.innerHTML = `
              <section class="p-4">
                <h2 class="text-xl font-bold text-green-700 mb-2 capitalize">Jaringan Saya</h2>
                <p>Berikut adalah struktur jaringan Anda:</p>
                <div id="networkContainer" class="mt-4"></div>
              </section>`;

            // Tambahin delay biar konten udah masuk ke DOM
            setTimeout(() => {
              loadNetwork();
            }, 100); // 100ms cukup bor
          }
          
          <section class="p-4">
            <h2 class="text-xl font-bold text-green-700 mb-4">Struktur Jaringan Anda</h2>

            <div id="networkContainer">
              <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">üë• Frontline (Level 1)</h3>
                <ul id="frontlineList" class="list-disc list-inside text-gray-700 dark:text-gray-300"></ul>
              </div>

              <div>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">üåø Downline (Level 2+)</h3>
                <ul id="downlineList" class="list-disc list-inside text-gray-700 dark:text-gray-300"></ul>
              </div>
            </div>
          </section>;
            setTimeout(() => {
              mainContent.innerHTML = `...struktur jaringan...`;
              loadNetwork(); // <-- ini penting, biar datanya dimuat setelah HTML-nya ada
            }, 300);
          }

      if (window.innerWidth < 768) toggleSidebar();
    }

    function logoutUser() {
      firebase.auth().signOut().then(() => {
        window.location.href = "index.html";
      });
    }
    
    async function loadNetwork() {
      const user = firebase.auth().currentUser;
      if (!user) return;

      const snapshot = await db.collection("users").where("email", "==", user.email).get();
      if (snapshot.empty) return;

      const userData = snapshot.docs[0].data();
      const userID = userData.username || snapshot.docs[0].id;

      const treeContainer = document.getElementById("networkTree");
      treeContainer.innerHTML = "<p class='text-gray-500'>Mengambil data jaringan...</p>";

      try {
        const usersSnapshot = await db.collection("users").get();
        const allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const frontline = allUsers.filter(u => u.parentID === userID);
        const downlineMap = {};

        frontline.forEach(f => {
          downlineMap[f.username || f.id] = allUsers.filter(d => d.parentID === (f.username || f.id));
        });

        let html = `<div class="mb-4"><h3 class="font-semibold text-green-700">Frontline:</h3>`;
        if (frontline.length === 0) {
          html += `<p class="text-sm text-gray-500">Belum ada frontline.</p>`;
        } else {
          frontline.forEach(f => {
            html += `<div class="ml-4 my-1 p-2 border rounded bg-white shadow-sm">
              <p><strong>${f.nama}</strong> (${f.email})</p>`;
            const down = downlineMap[f.username || f.id] || [];
            if (down.length > 0) {
              html += `<p class="mt-1 text-sm text-green-700">Downline:</p><ul class="list-disc ml-6">`;
              down.forEach(d => {
                html += `<li>${d.nama} (${d.email})</li>`;
              });
              html += `</ul>`;
            } else {
              html += `<p class="text-sm text-gray-400">Belum ada downline.</p>`;
            }
            html += `</div>`;
          });
        }
        html += `</div>`;
        treeContainer.innerHTML = html;
      } catch (error) {
        console.error("Gagal load jaringan:", error);
        treeContainer.innerHTML = "<p class='text-red-600'>Gagal mengambil data jaringan.</p>";
      }
    }
    async function loadNetwork() {
      const user = firebase.auth().currentUser;
      if (!user) return;

      try {
        const userQuery = await db.collection("users").where("email", "==", user.email).get();
        if (userQuery.empty) return;

        const userDoc = userQuery.docs[0];
        const userData = userDoc.data();

        const container = document.getElementById("networkContainer");
        container.innerHTML = `<p class="text-green-700 font-semibold">Memuat jaringan...</p>`;

        const frontlines = userData.frontlines || [];
        let html = `<h3 class="text-lg font-bold text-green-700 mt-4">Frontline (Level 1)</h3><ul class="list-disc pl-5">`;

        for (const uid of frontlines) {
          const doc = await db.collection("users").doc(uid).get();
          if (doc.exists) {
            const data = doc.data();
            html += `<li>${data.nama || 'Tanpa Nama'} (${data.email})</li>`;
          }
        }

        html += `</ul>`;
        container.innerHTML = html;

      } catch (err) {
        console.error("Gagal load jaringan:", err);
        document.getElementById("networkContainer").innerHTML = `<p class="text-red-600">Gagal memuat jaringan.</p>`;
      }
    }
  </script>
</body>
</html>
