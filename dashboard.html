<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Parmina Network</title>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    #sidebar {
      transform: translateX(-100%);
    }
    #sidebar.show {
      transform: translateX(0);
    }
    @media (min-width: 768px) {
      #sidebar {
        transform: none;
      }
    }
    .transition-soft {
      transition: transform 0.4s ease-in-out;
    }
    .animate-slide {
      transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row">
  <!-- Toggle Button for Mobile -->
  <div class="p-4 md:hidden flex justify-between items-center bg-white shadow">
    <button onclick="toggleSidebar()" class="text-green-700 focus:outline-none">
      <svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path id="menuPath" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
    <h2 class="text-xl font-bold text-green-700">Parmina Network</h2>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="bg-white w-64 p-4 shadow-lg transition-soft md:translate-x-0 md:relative fixed z-50 top-0 left-0 h-screen">
    <h2 class="text-2xl font-bold text-green-700 mb-6 hidden md:block">Parmina Network</h2>
    <nav>
      <ul class="space-y-2">
        <li><button type="button" onclick="navigateMenu('home')" class="text-green-700 hover:underline">🏠 Beranda</button></li>
        <li><button type="button" onclick="navigateMenu('network')" class="text-green-700 hover:underline">🌿 Jaringan Saya</button></li>
        <li><button type="button" onclick="navigateMenu('komisi')" class="text-green-700 hover:underline">💸 Komisi Saya</button></li>
        <li><button type="button" onclick="navigateMenu('bonus')" class="text-green-700 hover:underline">🎁 Bonus Reward</button></li>
        <li><button type="button" onclick="navigateMenu('riwayat')" class="text-green-700 hover:underline">📄 Riwayat Transaksi</button></li>
        <li><button type="button" onclick="navigateMenu('bop')" class="text-green-700 hover:underline">📢 BOP</button></li>
        <li><button type="button" onclick="navigateMenu('webinar')" class="text-green-700 hover:underline">🧑‍💻 Webinar</button></li>
        <li><button type="button" onclick="navigateMenu('seminar')" class="text-green-700 hover:underline">🎓 Boost Seminar</button></li>
        <li><button type="button" onclick="navigateMenu('galeri')" class="text-green-700 hover:underline">🖼️ Galeri</button></li>
        <li><button type="button" onclick="navigateMenu('profil')" class="text-green-700 hover:underline">👤 Profil & Akun</button></li>
        <li><button onclick="logoutUser()" class="text-red-600 hover:underline">🚪 Logout</button></li>
      </ul>
    </nav>
  </aside>

  <!-- Content -->
  <main class="flex-1 p-6 md:ml-0" id="mainContent">
    <section id="homeSection">
      <h1 class="text-2xl font-bold text-green-700 mb-4">Selamat Datang, <span id="userName">User</span> <span id="userBadge"></span></h1>
      <p><strong>Status:</strong> <span id="userStatus" class="font-semibold">Memuat...</span></p>
      <p><strong>Pembelian Pribadi:</strong> Rp<span id="personalPurchase">0</span></p>
      <p><strong>Omzet Jaringan:</strong> Rp<span id="networkOmzet">0</span></p>
      <p><strong>Sponsor:</strong> <span id="userSponsor">Memuat...</span></p>
      <p><strong>Parent Matrix:</strong> <span id="userParent">Memuat...</span></p>
    </section>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC6CD-KssIaBO0lGZbf5ymrH03uVfbNP-k",
      authDomain: "parminanetwork.firebaseapp.com",
      projectId: "parminanetwork",
      storageBucket: "parminanetwork.firebasestorage.app",
      messagingSenderId: "736943184054",
      appId: "1:736943184054:web:31fed7a4d10442870e2e17"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        try {
          // Cari dokumen berdasarkan UID atau username jika UID random
          const userQuery = await db.collection('users').where('email', '==', user.email).get();
          if (!userQuery.empty) {
            const userDoc = userQuery.docs[0];
            const data = userDoc.data();

            document.getElementById("userName").textContent = data.nama || "User";
            document.getElementById("personalPurchase").textContent = data.pembelianPribadi || 0;
            document.getElementById("networkOmzet").textContent = data.omzetJaringan || 0;

            const statusEl = document.getElementById("userStatus");
            const aktif = data.statusAktif === true || data.statusAktif === "true" || data.isTopLevel === true;
            statusEl.textContent = aktif ? "Aktif Bulan Ini" : "Belum Aktif Bulan Ini";
            statusEl.classList.remove("text-green-600", "text-red-600");
            statusEl.classList.add(aktif ? "text-green-600" : "text-red-600");

            if (data.isTopLevel === true) {
              document.getElementById("userBadge").innerHTML = "<span title='Top Leader' class='ml-2'>👑</span>";
            }

            // Tampilkan nama + email untuk sponsor dan parent
            if (data.sponsorID) {
              const sponsorRef = await db.collection('users').doc(data.sponsorID).get();
              const sponsorData = sponsorRef.data();
              document.getElementById("userSponsor").textContent =
              sponsorData ? `${sponsorData.nama} (${sponsorData.email})` : data.sponsorID;
            }

            if (data.parentID) {
              const parentRef = await db.collection('users').doc(data.parentID).get();
              const parentData = parentRef.data();
              document.getElementById("userParent").textContent =
              parentData ? `${parentData.nama} (${parentData.email})` : data.parentID;
            }
          } else {
            console.log("Dokumen pengguna tidak ditemukan.");
          }
        } catch (e) {
          console.error("Gagal load data pengguna:", e);
        }
      } else {
        window.location.href = "index.html";
      }
    });

    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const path = document.getElementById("menuPath");
      sidebar.classList.toggle("show");
      const isOpen = sidebar.classList.contains("show");
      path.setAttribute("d", isOpen ? "M6 18L18 6M6 6l12 12" : "M4 6h16M4 12h16M4 18h16");
    }

    function navigateMenu(menu) {
      const mainContent = document.getElementById("mainContent");
      mainContent.innerHTML = `
        <div class="flex items-center justify-center mt-10 animate-pulse">
          <p class="text-green-700 text-lg font-semibold">Memuat konten <span class="capitalize">${menu}</span>...</p>
        </div>`;
      setTimeout(() => {
        mainContent.innerHTML = `
          <section class="p-4">
            <h2 class="text-xl font-bold text-green-700 mb-2 capitalize">${menu.replace("-", " ")}</h2>
            <p>Konten halaman <strong>${menu}</strong> akan tampil di sini.</p>
          </section>`;
      }, 300);
      if (window.innerWidth < 768) toggleSidebar();
    }

    function logoutUser() {
      firebase.auth().signOut().then(() => {
        window.location.href = "index.html";
      });
    }
  </script>
</body>
</html>
