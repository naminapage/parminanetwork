<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Parmina Network</title>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    #sidebar {
      transform: translateX(-100%);
    }
    #sidebar.show {
      transform: translateX(0);
    }
    @media (min-width: 768px) {
      #sidebar {
        transform: none;
      }
    }
    .transition-soft {
      transition: transform 0.4s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row">
  <!-- Toggle Button for Mobile -->
  <div class="p-4 md:hidden flex justify-between items-center bg-white shadow">
    <button onclick="toggleSidebar()" class="text-green-700 focus:outline-none">
      <svg id="menuIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path id="menuPath" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
    <h2 class="text-xl font-bold text-green-700">Parmina Network</h2>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="bg-white w-64 p-4 shadow-lg transition-soft md:translate-x-0 md:relative fixed z-50 top-0 left-0 h-screen">
    <h2 class="text-2xl font-bold text-green-700 mb-6 hidden md:block">Parmina Network</h2>
    <nav>
      <ul class="space-y-2">
        <li><button type="button" onclick="navigateMenu('home')" class="text-green-700 hover:underline">üè† Beranda</button></li>
        <li><button type="button" onclick="navigateMenu('network')" class="text-green-700 hover:underline">üåø Jaringan Saya</button></li>
        <li><button type="button" onclick="navigateMenu('komisi')" class="text-green-700 hover:underline">üí∏ Komisi Saya</button></li>
        <li><button type="button" onclick="navigateMenu('bonus')" class="text-green-700 hover:underline">üéÅ Bonus Reward</button></li>
        <li><button type="button" onclick="navigateMenu('riwayat')" class="text-green-700 hover:underline">üìÑ Riwayat Transaksi</button></li>
        <li><button type="button" onclick="navigateMenu('bop')" class="text-green-700 hover:underline">üì¢ BOP</button></li>
        <li><button type="button" onclick="navigateMenu('webinar')" class="text-green-700 hover:underline">üßë‚Äçüíª Webinar</button></li>
        <li><button type="button" onclick="navigateMenu('seminar')" class="text-green-700 hover:underline">üéì Boost Seminar</button></li>
        <li><button type="button" onclick="navigateMenu('galeri')" class="text-green-700 hover:underline">üñºÔ∏è Galeri</button></li>
        <li><button type="button" onclick="navigateMenu('profil')" class="text-green-700 hover:underline">üë§ Profil & Akun</button></li>
        <li><button onclick="logoutUser()" class="text-red-600 hover:underline">üö™ Logout</button></li>
      </ul>
    </nav>
  </aside>

  <!-- Content -->
  <main class="flex-1 p-6 md:ml-0" id="mainContent">
    <!-- Sections -->
    <section id="homeSection">
      <h1 class="text-2xl font-bold text-green-700 mb-4">Selamat Datang, <span id="userName">User</span> <span id="userBadge"></span></h1>
      <p><strong>Status:</strong> <span id="userStatus" class="font-semibold text-red-600">Belum Aktif Bulan Ini</span></p>
      <p><strong>Pembelian Pribadi:</strong> Rp<span id="personalPurchase">0</span></p>
      <p><strong>Omzet Jaringan:</strong> Rp<span id="networkOmzet">0</span></p>
      <p><strong>Sponsor:</strong> <span id="userSponsor">Memuat...</span></p>
      <p><strong>Parent Matrix:</strong> <span id="userParent">Memuat...</span></p>
    </section>
    <section id="networkSection" class="hidden">
      <h2 class="text-xl font-bold text-green-700 mb-4">Jaringan Saya</h2>
      <div id="networkTree">
        <p class="text-gray-600">Loading struktur jaringan...</p>
      </div>
    </section>
    <section id="komisiSection" class="hidden"> <h2 class="text-xl font-bold text-green-700">Komisi Saya</h2> <p>Komisi sponsor, matrix, dan lainnya akan ditampilkan di sini.</p> </section>
    <section id="bonusSection" class="hidden"> <h2 class="text-xl font-bold text-green-700">Bonus Reward</h2> <p><a href="bonus.html" class="text-green-600 underline">Klik di sini untuk melihat Bonus Reward</a></p> </section>
    <section id="riwayatSection" class="hidden"> <h2 class="text-xl font-bold text-green-700">Riwayat Transaksi</h2> <p>Riwayat pembelian pribadi dan downline akan ditampilkan di sini.</p> </section>
    <section id="bopSection" class="hidden"> <h2 class="text-xl font-bold text-green-700">Business Opportunity Presentation</h2> <p>Informasi BOP akan ditampilkan di sini.</p> </section>
    <section id="webinarSection" class="hidden"> <h2 class="text-xl font-bold text-green-700">Webinar</h2> <p>Jadwal dan rekaman webinar akan ditampilkan di sini.</p> </section>
    <section id="seminarSection" class="hidden"> <h2 class="text-xl font-bold text-green-700">Boost Seminar</h2> <p>Informasi tentang seminar akan ditampilkan di sini.</p> </section>
    <section id="galeriSection" class="hidden"> <h2 class="text-xl font-bold text-green-700">Galeri</h2> <p>Dokumentasi acara dan kegiatan akan ditampilkan di sini.</p> </section>
    <section id="profilSection" class="hidden"> <h2 class="text-xl font-bold text-green-700">Profil & Akun</h2> <p>Fitur untuk edit profil dan password akan ditambahkan di sini.</p> </section>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC6CD-KssIaBO0lGZbf5ymrH03uVfbNP-k",
      authDomain: "parminanetwork.firebaseapp.com",
      projectId: "parminanetwork",
      storageBucket: "parminanetwork.firebasestorage.app",
      messagingSenderId: "736943184054",
      appId: "1:736943184054:web:31fed7a4d10442870e2e17"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function showSection(section) {
      const sections = ['home', 'network', 'komisi', 'bonus', 'riwayat', 'bop', 'webinar', 'seminar', 'galeri', 'profil'];
      sections.forEach(id => {
        document.getElementById(id + 'Section').classList.add('hidden');
      });
      document.getElementById(section + 'Section').classList.remove('hidden');
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('show');
      const path = document.getElementById('menuPath');
      if (sidebar.classList.contains('show')) {
        path.setAttribute("d", "M6 18L18 6M6 6l12 12");
      } else {
        path.setAttribute("d", "M4 6h16M4 12h16M4 18h16");
      }
    }

    function navigateMenu(section) {
      showSection(section);
      if (window.innerWidth < 768) toggleSidebar();
    }

    function logoutUser() {
      firebase.auth().signOut().then(() => {
        window.location.href = "index.html";
      });
    }

    async function buildNetworkTree(uid, level = 1) {
      if (level > 3) return "";

      const downlines = await db.collection("users").where("parent", "==", uid).get();
      if (downlines.empty) return "";

      let html = `<ul class="ml-${level * 4} list-disc text-green-800">`;
      for (const doc of downlines.docs) {
        const d = doc.data();
        const nama = d.nama || "Tanpa Nama";
        const id = doc.id;
        html += `<li>${nama} (${id})`;
        const childTree = await buildNetworkTree(id, level + 1);
        html += childTree;
        html += `</li>`;
      }
      html += `</ul>`;
      return html;
    }

    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          const data = userDoc.data();
          document.getElementById("userName").textContent = data.nama || "User";
          document.getElementById("personalPurchase").textContent = data.pembelianPribadi || 0;
          document.getElementById("networkOmzet").textContent = data.omzetJaringan || 0;

          const aktif = data.statusAktif || data.isTopLevel;
          document.getElementById("userStatus").textContent = aktif ? "Aktif Bulan Ini" : "Belum Aktif Bulan Ini";
          document.getElementById("userStatus").classList.toggle("text-green-600", aktif);
          document.getElementById("userStatus").classList.toggle("text-red-600", !aktif);

          if (data.isTopLevel === true) {
            document.getElementById("userBadge").innerHTML = "<span title='Top Leader' class='ml-2'>üëë</span>";
          }

          if (data.sponsor) {
            const sponsorDoc = await db.collection('users').doc(data.sponsor).get();
            if (sponsorDoc.exists) {
              const sponsorData = sponsorDoc.data();
              document.getElementById("userSponsor").textContent = sponsorData.nama || data.sponsor;
            } else {
              document.getElementById("userSponsor").textContent = data.sponsor;
            }
          } else {
            document.getElementById("userSponsor").textContent = "-";
          }

          if (data.parent) {
            const parentDoc = await db.collection('users').doc(data.parent).get();
            if (parentDoc.exists) {
              const parentData = parentDoc.data();
              document.getElementById("userParent").textContent = parentData.nama || data.parent;
            } else {
              document.getElementById("userParent").textContent = data.parent;
            }
          } else {
            document.getElementById("userParent").textContent = "-";
          }

          const treeHTML = await buildNetworkTree(user.uid);
          document.getElementById("networkTree").innerHTML = treeHTML || `<p class="text-gray-600">Belum ada downline langsung.</p>`;
        }
      } else {
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
