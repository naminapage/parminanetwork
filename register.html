<script>
  async function register() {
    const name = document.getElementById('name').value.trim();
    const username = document.getElementById('username').value.trim().toLowerCase();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const sponsorCodeInput = document.getElementById('sponsorCodeInput').value.trim();
    const errorMsg = document.getElementById('errorMsg');
    const successMsg = document.getElementById('successMsg');

    errorMsg.textContent = "";
    successMsg.textContent = "";

    if (!name || !username || !email || !password || !sponsorCodeInput) {
      errorMsg.textContent = "Isi semua kolom dengan lengkap!";
      return;
    }

    const usernameCheck = await db.collection("users").doc(username).get();
    if (usernameCheck.exists && usernameCheck.data().email) {
      errorMsg.textContent = "Username sudah dipakai. Silakan pilih yang lain.";
      return;
    }

    const sponsorSnapshot = await db.collection("users").where("username", "==", sponsorCodeInput).limit(1).get();
    if (sponsorSnapshot.empty) {
      errorMsg.textContent = "Kode Sponsor tidak valid! Tanyakan pada pengundang Anda.";
      return;
    }

    const sponsorDoc = sponsorSnapshot.docs[0];
    const sponsorID = sponsorDoc.id;

    // ðŸ”„ Auto Placement (cari parent ID)
    async function findAvailableParent(startID, maxDepth = 10) {
      const queue = [{ id: startID, level: 1 }];
      while (queue.length > 0) {
        const current = queue.shift();
        if (current.level > maxDepth) break;

        const snapshot = await db.collection("users").doc(current.id).get();
        const data = snapshot.data();
        const downlines = data.downlines || [];

        if (downlines.length < 3) {
          return current.id;
        }

        downlines.forEach(id => {
          queue.push({ id, level: current.level + 1 });
        });
      }
      return startID; // fallback
    }

    const parentID = await findAvailableParent(sponsorID);

    try {
      const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
      const uid = userCredential.user.uid;

      await db.collection("users").doc(username).set({
        name,
        username,
        email,
        sponsorID,
        sponsorCode: sponsorCodeInput,
        parentID,
        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
        downlines: [],
        totalSales: 0,
        pembelianPribadi: 0,
        omzetJaringan: 0,
        komisiSponsor: 0,
        komisiMatrix: 0,
        totalKomisi: 0,
        bonusReward: 0,
        levelReward: "",
        statusAktif: false,
        isAdmin: false,
        transactions: []
      });

      // Tambahkan ke downlines sponsor
      await db.collection("users").doc(sponsorID).update({
        downlines: firebase.firestore.FieldValue.arrayUnion(username)
      });

      // Tambahkan juga ke downlines parent
      if (parentID !== sponsorID) {
        await db.collection("users").doc(parentID).update({
          downlines: firebase.firestore.FieldValue.arrayUnion(username)
        });
      }

      await userCredential.user.sendEmailVerification();
      successMsg.textContent = "Pendaftaran berhasil! Silakan verifikasi email Anda sebelum login.";

    } catch (error) {
      console.error("Pendaftaran gagal:", error);
      errorMsg.textContent = "Pendaftaran gagal: " + error.message;
    }
  }
</script>
